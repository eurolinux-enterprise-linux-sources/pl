dnl Process this file with autoconf to produce a configure script.

AC_INIT(install-sh)
AC_PREREQ([2.50])
AC_CONFIG_HEADER(config.h)

AC_SUBST(LIBS)
AC_SUBST(PL)
AC_SUBST(PLLIBS)
AC_SUBST(PLBASE)
AC_SUBST(PLARCH)
AC_SUBST(BOOTPL)
AC_SUBST(PLINCLUDE)
AC_SUBST(CIFLAGS)
AC_SUBST(COFLAGS)
AC_SUBST(CWFLAGS)
AC_SUBST(CMFLAGS)
AC_SUBST(ETAGS)
AC_SUBST(LD)
AC_SUBST(SO)
AC_SUBST(LOCALLIB)
AC_SUBST(LDSOFLAGS)
AC_SUBST(SONAMEFLAG)
AC_SUBST(SOWHOLEARCHIVE)

LOCALLIB=
LD=ld
AC_PROG_CC

AC_ARG_WITH(gmp-include,[  --with-gmp-include=DIR  DIR holding gmp.h],
	[ case $withval in
		no|yes) echo 'Specify dir holding gmp.h'
			exit 1
			;;
		*)	CIFLAGS="-I$withval $CIFLAGS"
			;;
	  esac
	])
AC_ARG_WITH(gmp-lib,    [  --with-gmp-lib=DIR      DIR holding libgmp.{a,so}],
	[ case $withval in
		no|yes) echo 'Specify dir holding libgmp.{a,so}'
			exit 1
			;;
		*)	LDFLAGS="-L$withval $LDFLAGS"
			LOCALLIB="-L$withval -lgmp"
			;;
	  esac
	])

if test -z "$PLINCL"; then
plcandidates="swi-prolog swipl pl"
AC_CHECK_PROGS(PL, $plcandidates, "none")
AC_CHECK_PROGS(PLLD, plld, "none")
if test $PLLD = "none"; then
   AC_ERROR("Cannot find SWI-Prolog plld utility. SWI-Prolog must be installed first")
fi
if test $PL = "none"; then
   AC_ERROR("Cannot find SWI-Prolog. SWI-Prolog must be installed first")
else
   AC_CHECKING("Running $PL -dump-runtime-variables")
   eval `$PL -dump-runtime-variables`
fi
PLINCL=$PLBASE/include
AC_MSG_RESULT("		PLBASE=$PLBASE")
AC_MSG_RESULT("		PLARCH=$PLARCH")
AC_MSG_RESULT("		PLLIBS=$PLLIBS")
AC_MSG_RESULT("		PLLDFLAGS=$PLLDFLAGS")
AC_MSG_RESULT("		PLSHARED=$PLSHARED")
AC_MSG_RESULT("		PLSOEXT=$PLSOEXT")
else
PLLD=../plld.sh
fi

CC=$PLLD
LD=$PLLD
LDSOFLAGS=-shared
CMFLAGS=-fpic

SO="$PLSOEXT"


AC_CHECK_PROGS(MAKE, gmake make, "make")
AC_CHECK_PROGS(ETAGS, etags ctags, ":")
AC_PROG_INSTALL
AC_PROG_CPP
AC_ISC_POSIX
AC_HEADER_STDC

if test ! -z "$GCC"; then
    COFLAGS="${COFLAGS--O2 -fno-strict-aliasing}"
    CWFLAGS="${CWFLAGS--Wall}"
else
    COFLAGS="${COFLAGS--O}"
fi

CFLAGS="$CIFLAGS $CMFLAGS"
AC_FUNC_ALLOCA
AC_C_BIGENDIAN

AC_MSG_CHECKING("Whether we can link to -lgmp")
LIBS="$LIBS -lgmp"
AC_TRY_LINK([#include <gmp.h>],
	    [mpz_t r; mpz_init(r);],
	    AC_MSG_RESULT(yes),
	    AC_DEFINE(HAVE_LIBGMP, 1, [Define if you have -lgmp]),
	    AC_MSG_RESULT(no)
	    exit 1)
			     
AC_CHECK_HEADERS(malloc.h unistd.h sys/time.h fcntl.h)
AC_CHECK_FUNCS(setsid strerror)

AC_OUTPUT(Makefile)
